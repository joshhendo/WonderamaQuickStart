<html>
<head>
	<title>Wonderama Configuration</title>

	<script type="text/javascript" src="js/cookies.js"></script>

	<script>	
		String.prototype.startsWith = function(str) {return (this.match("^"+str)==str)}
		
		// Set some global variables
		var gPosition = '';
		
		// Some WebSocket stuff
		var relaySocket  = new WebSocket("ws://192.168.0.108:3001/ks1205");
		relaySocket.onopen  = function ()
		{
			console.log("relaySocket Connection established");
		};
		
		relaySocket.onclose  = function ()
		{
			console.log("relaySocket Connection closed");
		}
		
		relaySocket.onerror  = function(evt)
		{
			console.log("relaySocket error.");
		};
		
		relaySocket.onmessage  = function (evt)
		{
			console.log("recv:"+ evt.data);
			// Interpret message
			
			var message = new Array();
			message = evt.data.split("#");
			
			if (message[0] == "goto")
			{
				GoTo(message[1]);
			}
			
			if (message[0] == "query")
			{
				Query(message[1]);	
			}
			
			if (message[0] == "exist")
			{
				Exist(message[1]);	
			}
			
		}
		
		function doSend(message)
		{
			 console.log("send:"+message);
			 relaySocket.send(message);
		}		
		
		// Hide appropriate div's
		function OnStart()
		{
			document.getElementById('none').style.display = '';
			document.getElementById('master').style.display = 'none';
			document.getElementById('slave').style.display  = 'none';
		}
		
		// Listen for keypresses
		function OnKey(evt)
		{
			var key = (evt) ? evt.which : evt.keyCode;
			
			// Key 13 == ENTER
			if (key == 13 && gPosition == 'M')
			{
				// Direct all slaves to go to the next page
				doSend('goto#next');
				
				// Go to next page yourself.
				GoTo('next');
			}
		}
		
		function GoTo(where)
		{
			if (where == "next")
			{
				window.location = "viewer.html";	
			}
		}
		
		// Respond to query if current position matches 
		function Query(position)
		{
			if (position == gPosition)
			{
				doSend('exist#' + position);	
			}
		}
		
		function Exist(position)
		{
			if (position == gPosition)
			{
				alert('The screen you attempted to select already exists. Please select another one.');
				gPosition == '';
				OnStart();
			}
		}
		
		function SendQuery(position)
		{
			doSend('query#' + position);	
		}

		function setComputer(position)
		{
			gPosition = position;
			Set_Cookie( 'position', position, 30, '/', '', '' );

			// Now we want to set a default offset based on the position.
			if (position == 'M')
			{
				setRotation(0);
				setMaster(true)
			}
			else
			{
				positive = 1;
				if (position.startsWith('L'))
				{
					positive = -1;
				}

				// Get the offset value
				setRotation(30*positive);

				setMaster(false);
			}
			
			SendQuery(position);
			
		}

		function setRotation(rot)
		{
			Set_Cookie( 'rot', rot, 30, '/', '', '' );
		}

		function setMaster(master)
		{
			Set_Cookie( 'master', master, 30, '/', '', '' );
			
			if (master)
			{
				document.getElementById('none').style.display = 'none';
				document.getElementById('master').style.display = '';
				document.getElementById('slave').style.display  = 'none';
			}
			else
			{
				document.getElementById('none').style.display = 'none';
				document.getElementById('master').style.display = 'none';
				document.getElementById('slave').style.display  = '';
			}
			
		}
	</script>
    
<link href="css/style.css" rel="stylesheet" type="text/css">
</head>

<body onLoad="OnStart()" onKeyPress="OnKey(event)">

<div id="Wrap">
	<div class="wrapper">	
		<h1>Wonderama Setup</h1>
    </div>
</div>
<div id="Content" class="wrapper">
	<h2>Selecting screen</h2>
    
    <ol>
		<li>Select number of screens to be used</li>
		<li>Select screen below to which this screen is to be placed</li>
		<li>Click to continue to the next step when done with selection and placement of screens</li>
	</ol>

	<label>Number of screens:</label>
	<select name="screens"/>
		<option value="1" selected="selected">5</option>
	</select>
    
    
    <div id="Screens">
    	<div id="none">
		<p>You need to select your position before being able to continue.</p>
		</div>
		<div id="master">
			<p>You are the master. Press ENTER to continue.</p>
		</div>
		<div id="slave">
			<p>You are a slave. You will continue when the Mater continues.</p>
		</div>
      <a href="#" onClick="setComputer('L2')">
      <img src="images/monitor_L2.png" width="152" height="254"/>
      </a>
    
      <a href="#" onClick="setComputer('L1')">
      <img src="images/monitor_L1.png" width="106" height="254"/>
      </a>
      
      <a href="#" onClick="setComputer('M')">
      <img src="images/monitor_M.png" width="106" height="254"/>
      </a>
      
      <a href="#" onClick="setComputer('R1')">
      <img src="images/monitor_R1.png" width="104" height="254"/>
      </a>
    
      <a href="#" onClick="setComputer('R2')">
      <img src="images/monitor_R2.png" width="152" height="254"/>
      </a>
    </div>
   
</div>
</body>
</html>